<!DOCTYPE html>
<html>
<head>
	<!-- <link rel='stylesheet' href="stylesheet.css"> -->
	<title>Match Scouting</title>
	<link rel='stylesheet' href="w3.css">
	<link rel='stylesheet' href="w3-theme-red.css">
	<link rel='stylesheet' href="style.css">
	<link rel="icon" href="logo.ico" type="image/ico" sizes="16x16">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<script src="teamData.js"></script>
	<script src="scheduleData.js"></script>
</head>

<body class="w3-theme-d3">      
<div class="w3-dropdown-hover" style="width:100%;">
    <button class="w3-btn-block w3-theme-l3 w3-large w3-border w3-border-black w3-text-red w3-round w3-text-white w3-round-xxlarge"><strong>Menu</strong></button>
    <div class="w3-dropdown-content w3-bar-block w3-border" style="width:240px;">
      	<a href='index.html' class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Match Scouting</a>
		<a href="pitscouting.html" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Pit Scouting</a>
		<a href="report.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Team Reports</a>
		<a href="schedule.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Schedule</a>
		<a href="schedule967.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">967 Schedule</a>
		<a href="schedule5576.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">5576 Schedule</a>
		<a href="teams.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Team List</a>
		<a href="stats.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Scout Stats</a>
		<a href="matches.php" class="w3-button w3-xlarge w3-block w3-red w3-hover-blue w3-bar-item">Active/Recent</a>
    </div>
</div>

<div class="w3-panel w3-theme-l3 w3-padding-small w3-round w3-border w3-border-black w3-text-white ">
<h4>Match Scouting</h4>
<p class="status">Status text will display here</p>   
<label for="matchnum">Match</label><br>
<input type="number" name="matchnum" id="matchnum" min="1" max = "100" value="1">
<label for="practice">Practice?</label>
<input type="checkbox" name="practice" id="practice"><br><br>
<!-- <strong><span style="margin-left: 10px" id="event_info"></span></strong><br><br> -->

Team Number:<br>
<!-- <button id="teamRefresh">Refresh Teams</button><br><br> -->
<select id="team" name="team">
	<option value=100>100</option>
	<option value=200>200</option>
	<option value=300>300</option>
	<option value=400>400</option>
	<option value=500>500</option>
	<option value=600>600</option>
</select><span id="nickname" style="margin-left: 10px;"></span>
<button id="refreshButton">Refresh Teams</button>
<br><br>

Scout Name:<br>
<input type="text" name="scout_name" value="" id="scout_name" onfocusout="activeScout();"><br>
</div>

<div class="w3-panel w3-theme-l3 w3-padding-small w3-round w3-border w3-border-black w3-text-white ">
<h3>Sandstorm</h3>
<label for="habline">Habline Crossing</label><br>
<select id="habline">
	<option value="">???</option>
	<option value="-">did not move</option>
	<option value="X">not far enough</option>
	<option value="L1">crossed (Level 1)</option>
	<option value="L2">crossed (Level 2)</option>
</select><br><br>

<label for="sandstorm_preload">Preload Game Piece</label><br>
<select id="sandstorm_preload">
	<option value="">???</option>
	<option value="-">none</option>
	<option value="C">Hatch Panel</option>
	<option value="H">Cargo Ball</option>
</select><br><br>

<label for="sandstorm_action">Sandstorm Game Piece Attempt</label><br>
<select id="sandstorm_action">
	<option value="">???</option>
	<option value="-">none</option>
	<option value="Cf">front cargo ship</option>
	<option value="Cs">side cargo ship</option>
	<option value="Rc">close rocket hatch</option>
	<option value="Rf">far rocket hatch</option>
	<option value="FS">collect hatch</option>
</select><br><br>

<label for="sandstorm_success">Game Piece Successful?</label><br>
<select id="sandstorm_success">
	<option value="">???</option>
	<option value="-">No Game Piece Action</option>
	<option value="X">Miss / Drop / not lined up</option>
	<option value="h">Lined up OK and piece not dropped</option>
	<option value="1">Successfully Scored</option>
</select><br>
</div>            


<!-- TeleOp -->
<div class="w3-panel w3-theme-l3 w3-padding-small w3-round w3-border w3-border-black w3-text-white ">

<h3>TeleOp</h3>
<table style="border: 1px solid yellow;">
<tr><th>Hatch Miss/Drop</th><th>Hatch Scored</th></tr>
<tr>
	<td><button class="m1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="m1hatch_missed">-1</button>
	<button class="p1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="p1hatch_missed">+1</button>
	<input type="number" id="hatch_missed" value=0 min=0 max=99></input></td>
	<td><input type="number" id="hatch_made" value=0 min=0 max=99></input>
	<button class="m1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="m1hatch_made">-1</button>
	<button class="p1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="p1hatch_made">+1</button></td>
</tr>
</table><br>

<table style="border: 1px solid darkorange;">
<tr><th>Cargo Miss/Drop</th><th>Cargo Scored</th></tr>
<tr>
	<td><button class="m1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="m1cargo_missed">-1</button>
	<button class="p1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="p1cargo_missed">+1</button>
	<input type="number" id="cargo_missed" value=0 min=0 max=99></input></td>
	<td><input type="number" id="cargo_made" value=0 min=0 max=99></input>
	<button class="m1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="m1cargo_made">-1</button>
	<button class="p1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="p1cargo_made">+1</button></td>
</tr>
</table><br>


<label for="difficulty">Highest Successful Difficulty Level</label><br>
<select id="difficulty">
	<option value="">???</option>
	<option value="none">0 None</option>
	<option value="1C">1 L1 cargo ball</option>
	<option value="1f">2 L1 front hatch</option>
	<option value="1h">3 L1 side/back hatch</option>
	<option value="R2">4 Rocket ship Level 2</option>
	<option value="R3">5 Rocket ship Level 3</option>

</select><br><br>

<label for="climb">Hab Climb</label><br>
<select id="climb">
	<option value="">???</option>
	<option value="-">Not Attempted</option>
	<option value="1">L1 Success</option>
	<option value="-1">L1 Failed</option>
	<option value="S2">L2 Success</option>
	<option value="F2">L2 Failed</option>
	<option value="S3">L3 Success</option>
	<option value="F3">L3 Failed</option>
	<option value="SR">Ramp Success</option>
	<option value="FR">Ramp Failed</option>
</select><br>
<em>(Ramps count for the robot that has the ramp)</em><br><br>

<label for="incap">Incapacitated</label>
<input type="checkbox" name="incap" id="incap">
<em>(Describe in comments)</em>
<br>
<br>
<label for="defense">Defense</label>
<input type="checkbox" name="defense" id="defense">
<em>(Describe in comments)</em>
<br>
</div>

<div class="w3-panel w3-theme-l3 w3-padding-small w3-round w3-border w3-border-black w3-text-white ">
<h3>Fouls, Yellow/Red Cards</h3>
<button class="m1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="m1foul">-1</button>
<input type="number" id="foul" value=0 min=0 max=99></input>
<button class="p1 w3-btn w3-theme-l2 w3-border w3-border-black w3-round-large" id="p1foul">+1</button><br>
<p>
	<strong>Use comments to say what they did OR list rule #.</strong><br>
		<strong>G3</strong>: crossing center line in sandstorm<br>
		<strong>G6</strong>: launching a hatch panel<br>
		<strong>G9</strong>: two defenders on opponent's side<br>
		<strong>G10</strong>: extending manipulator on opp's side<br>
		<strong>G11</strong>: throwing/kicking cargo on opp's side<br>
		<strong>G13</strong>: touching a robot in its hab zone<br>
		<strong>G16</strong>: hitting opp's rocket in last 20 sec<br>
		<strong>G18</strong>: pinning / trapping longer than 5 sec<br>
		<strong>C8</strong>: forcing opponent to commit a foul<br>
</p>
</div>

<div class="w3-panel w3-theme-l3 w3-padding-small w3-round w3-border w3-border-black w3-text-white">
<h3>Comments</h3>

<!--Comments:<br>
<input type="text" name="comments" value="" id="comments">-->
<textarea placeholder="Insert Comments Here" name="comments" value="" id="comments" style="width:100%;height:150px;"></textarea>

</div>

<input type="submit" value="Submit" id="submit" class="w3-btn-block w3-theme-l3 w3-border w3-border-black w3-text-red w3-round w3-text-white">

<p class="status">Status text will display here</p>
<p>Random Text for scrolling...</p>
<p>Random Text for scrolling...</p>
<p>Random Text for scrolling...</p>
<p>Random Text for scrolling...</p>
<p>Random Text for scrolling...</p>
<p>Random Text for scrolling...</p>
<script>

plus = document.getElementsByClassName('p1');
for (i=0; i<plus.length; i++){
	var val_id = plus[i].id.substring(2);
	plus[i].addEventListener("click",closure(val_id, 1));
}

minus = document.getElementsByClassName('m1');
for (i=0; i<minus.length; i++){
	var val_id = minus[i].id.substring(2);
	minus[i].addEventListener("click",closure(val_id, -1));
}

function closure(id, amt){
	return function(){
		if ( parseInt(document.getElementById(id).value) + amt >= 0){
			document.getElementById(id).value = parseInt(document.getElementById(id).value) + amt;
		}
	}
}

function updateTeams(arr, matchnum){
	var teamList = [];
	//add a '0' value to the beginning to avoid letting humans forget to select and default to first in list
	if(arr.length > 0){
		for (i = 0; i < arr.length; i++) {
			if (arr[i]["comp_level"]==="qm"){
				if(arr[i]["match_number"]==matchnum){
					var red = arr[i]['alliances']['red']['team_keys'];
					var blue = arr[i]['alliances']['blue']['team_keys'];
					teamList.push(parseInt(red[0].slice(3)));
					teamList.push(parseInt(red[1].slice(3)));
					teamList.push(parseInt(red[2].slice(3)));
					teamList.push(parseInt(blue[0].slice(3)));
					teamList.push(parseInt(blue[1].slice(3)));
					teamList.push(parseInt(blue[2].slice(3)));
					break;
				}
			}
		}
	} else {
		document.getElementById('practice').checked = true;
		for (i = 0; i < teamData.length; i++){
			teamList.push(parseInt(teamData[i]["team_number"]));
		}
		teamList.sort(function compareInt(a, b){return parseInt(a)-parseInt(b)});
	}
	if (teamList.length == 6){
		var slots = ['Red 1: ', 'Red 2: ', 'Red 3: ', 'Blue1: ', 'Blue2: ', 'Blue3: '];
		var choices = '';
		choices += '<option value=0>Choose Team</option>\n';
		for(i = 0; i < teamList.length; i++){
			var team = teamList[i];
			choices += '<option value='+team+'>'+slots[i]+team+'</option>\n';
		}			
	}  
	else {
		var choices = '';
		choices += '<option value=0>Choose Team</option>\n';
		for(i = 0; i < teamList.length; i++){
			var team = teamList[i];
			choices += '<option value='+team+'>'+team+'</option>\n';
		}			
	}
	

	document.getElementById('team').innerHTML = choices;
}

function updateNickname(arr, teamnum){
	for (i = 0; i < arr.length; i++){
		if (arr[i]['team_number']==teamnum){
			document.getElementById('nickname').innerHTML = arr[i]['nickname'];
			return;
		}
		document.getElementById('nickname').innerHTML = "";
	}
}

function validateForm(){
	var matchnum = document.getElementById('matchnum').value;
	var team = document.getElementById('team').value;
	var scout_name = document.getElementById('scout_name').value;
	var validated = true;
	if(matchnum==null||isNaN(matchnum)||team==null||team==0||team==""||scout_name==""||scout_name==null||scout_name.length<2){
		validated = false;
		// status('Fill out match number, team, and scout name.');
	}
	//validate HTML form data
	//if form input is invalid, validated = false
	return validated;
}

function status(m){
	document.getElementsByClassName('status')[0].innerHTML = m;
	document.getElementsByClassName('status')[1].innerHTML = m;
}

function submitData(){
	status("Starting Request");
	var xhr = new XMLHttpRequest();
	var params = '';
	params += 'team=' + document.getElementById('team').value;
	params += '&event_code=iacf';
	params += '&scout_name=' + document.getElementById('scout_name').value;
	
	params += '&practice='+ (document.getElementById('practice').checked ? 1:0);
	if (document.getElementById('practice').checked) {
		//negative numbers for practice matches
		params += '&matchnum='+ -1*document.getElementById('matchnum').value;
	}
	else {
		params += '&matchnum='+ document.getElementById('matchnum').value;	
	}
	params += '&scout_name='+ document.getElementById('scout_name').value;
	params += '&habline=' + document.getElementById('habline').value;
	params += '&sandstorm_preload=' + document.getElementById('sandstorm_preload').value;
	params += '&sandstorm_action=' + document.getElementById('sandstorm_action').value;
	params += '&sandstorm_success=' + document.getElementById('sandstorm_success').value;
	params += '&hatch_made=' + document.getElementById('hatch_made').value;
	params += '&hatch_missed=' + document.getElementById('hatch_missed').value;
	params += '&cargo_made=' + document.getElementById('cargo_made').value;
	params += '&cargo_missed=' + document.getElementById('cargo_missed').value;
	params += '&difficulty=' + document.getElementById('difficulty').value;
	params += '&climb='+ document.getElementById('climb').value;
	params += '&foul='+ document.getElementById('foul').value;
	params += '&defense='+ (document.getElementById('defense').checked ? 1:0);
	params += '&incap='+ (document.getElementById('incap').checked ? 1:0);
	params += '&comments='+ document.getElementById('comments').value;

	xhr.onreadystatechange = function(){
		if(this.readyState == 4 & this.status == 200){
			status(this.responseText);
			if (this.responseText.substr(this.responseText.length - 13) == "successfully."){
				clearData();
				document.getElementById('team').value=0;
				document.getElementById('matchnum').value = parseInt(document.getElementById('matchnum').value) + 1;
				updateTeams(scheduleData, document.getElementById('matchnum').value);
			}
		}
	}
	
	xhr.open("POST", "insert_match.php", true); 
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send(encodeURI(params));
	status("Sending Data...");
}

function clearData(){
	document.getElementById('scout_name').value="";
	document.getElementById('habline').value = "";
	document.getElementById('sandstorm_preload').value = "";
	document.getElementById('sandstorm_action').value = "";
	document.getElementById('sandstorm_success').value = "";
	document.getElementById('hatch_made').value = 0;
	document.getElementById('hatch_missed').value = 0;
	document.getElementById('cargo_made').value = 0;
	document.getElementById('cargo_missed').value = 0;
	document.getElementById('difficulty').value = "";
	document.getElementById('climb').value="";
	document.getElementById('foul').value = 0;
	document.getElementById('defense').checked=false;
	document.getElementById('incap').checked=false;
	document.getElementById('comments').value="";
	updateNickname(teamData, document.getElementById('team').value);
}

function lookupMatchData(){
	status("Starting Request");

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(this.readyState == 4 & this.status == 200){
			if (xhr.responseText != 'null'){
				status("Found data for Match "+document.getElementById('matchnum').value +" team " + document.getElementById('team').value);

				var data = JSON.parse(xhr.responseText);
				//List lots of variables
				document.getElementById('scout_name').value = data['scout_name'];
				document.getElementById('habline').value = data['habline'];
				document.getElementById('sandstorm_preload').value = data['sandstorm_preload'];
				document.getElementById('sandstorm_action').value = data['sandstorm_action'];
				document.getElementById('sandstorm_success').value = data['sandstorm_success'];
				document.getElementById('hatch_made').value = data['hatch_made'];
				document.getElementById('hatch_missed').value = data['hatch_missed'];
				document.getElementById('cargo_made').value = data['cargo_made'];
				document.getElementById('cargo_missed').value = data['cargo_missed'];
				document.getElementById('difficulty').value = data['difficulty'];
				document.getElementById('climb').value = data['climb'];
				document.getElementById('foul').value = data['foul'];
				document.getElementById('defense').checked = !! + data['defense'];
				document.getElementById('incap').checked = !! + data['incap'];
				document.getElementById('comments').value = data['comments'];
			}
			else {
				status("No data for Match "+document.getElementById('matchnum').value +" team " + document.getElementById('team').value);
				//document.getElementById('scout_name').value = "";
				clearData();
			}
		}
		else{
			status("Looking for Match "+document.getElementById('matchnum').value +" team " + document.getElementById('team').value);
		}
	};
	xhr.open('GET', 'match_team_get.php?team=' + document.getElementById('team').value + '&matchnum='+document.getElementById('matchnum').value);
	xhr.send();
}

document.addEventListener("DOMContentLoaded", function() {
	//Document ready function
	updateTeams(scheduleData, document.getElementById('matchnum').value);

	document.getElementById('matchnum').addEventListener("change", function(){
		updateTeams(scheduleData, document.getElementById('matchnum').value);
	});

	document.getElementById('team').addEventListener("change", function(){
		updateNickname(teamData, document.getElementById('team').value);
		lookupMatchData();

	});

	document.getElementById('submit').addEventListener("click", function(){
		if (validateForm()){
			submitData();
		}
		else {
			status("Form data incomplete - needs match number, team, and scout name.");
		}
	});
	document.getElementById('refreshButton').addEventListener("click", function(){
		updateTeams(scheduleData, document.getElementById('matchnum').value);
	});


});

function activeScout(){
	if(validateForm()){
		var xhr = new XMLHttpRequest();
		var params = 'team=' + document.getElementById('team').value;
		params += '&scout_name=' + document.getElementById('scout_name').value;
		if (document.getElementById('practice').checked) {
		//negative numbers for practice matches
		params += '&matchnum='+ -1*document.getElementById('matchnum').value;
		}
		else {
			params += '&matchnum='+ document.getElementById('matchnum').value;	
		}
		console.log(params);
		xhr.open("POST", "activescout.php", true); 
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		// xhr.onload= function() {
		// 	console.log("Response: "+ this.responseText);
		// };
		xhr.send(encodeURI(params));
	}
}

</script>

</body>
</html>
